
<!DOCTYPE html>
<html>
<head>
  <title>NAC Map with Corrected Bounding Box</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #nacBox {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: sans-serif;
      font-size: 12px;
      z-index: 1000;
      cursor: pointer;
    }
    #searchBox {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 8px;
      border-radius: 4px;
      font-family: sans-serif;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="nacBox" title="Click to copy to clipboard">NAC: -- | Lat/Lon: --</div>
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Search NAC, address, or lat,lon" style="width: 240px">
    <button onclick="handleSearch()">Search</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([43.65, -79.38], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const nacBox = document.getElementById('nacBox');
    const searchInput = document.getElementById('searchInput');

    const nacChars = "0123456789BCDFGHJKLMNPQRSTVWXZ";
    const base = 30;

    let marker, boxLayer;

    function decodeNAC(nac, center = false) {
      const [lonCode, latCode] = nac.toUpperCase().split(' ');
      const level = lonCode.length;
      let lonNorm = 0, latNorm = 0, factor = 1;

      for (let i = 0; i < level; i++) {
        factor /= base;
        lonNorm += nacChars.indexOf(lonCode[i]) * factor;
        latNorm += nacChars.indexOf(latCode[i]) * factor;
      }

      const resolution = Math.pow(base, -level);
      const lon = lonNorm * 360 - 180 + (center ? resolution * 180 : 0) / 2;
      const lat = latNorm * 180 - 90 + (center ? resolution * 180 : 0) / 2;

      return { level, lon, lat, resolution };
    }

    function expandNACComponent(component) {
      if (!component.includes('-')) return [component];
      const match = component.match(/^(.*?)([0-9BCDFGHJKLMNPQRSTVWXZ])-([0-9BCDFGHJKLMNPQRSTVWXZ])$/);
      if (!match) return [component];
      const [_, prefix, from, to] = match;
      const i1 = nacChars.indexOf(from);
      const i2 = nacChars.indexOf(to);
      if (i1 < 0 || i2 < 0 || i1 > i2) return [component];
      return nacChars.slice(i1, i2 + 1).split('').map(ch => prefix + ch);
    }

    function getBoundingBox(lonCodeRaw, latCodeRaw) {
      const lonCodes = expandNACComponent(lonCodeRaw);
      const latCodes = expandNACComponent(latCodeRaw);

      let minLat = Infinity, maxLat = -Infinity, minLon = Infinity, maxLon = -Infinity;

      for (const lonCode of lonCodes) {
        for (const latCode of latCodes) {
          const nac = `${lonCode} ${latCode}`;
          const { lat, lon, resolution } = decodeNAC(nac, false);
          const lat2 = lat + resolution * 180;
          const lon2 = lon + resolution * 360;
          minLat = Math.min(minLat, lat);
          maxLat = Math.max(maxLat, lat2);
          minLon = Math.min(minLon, lon);
          maxLon = Math.max(maxLon, lon2);
        }
      }

      return L.latLngBounds([minLat, minLon], [maxLat, maxLon]);
    }

    function encodeNAC(level, lon, lat) {
      let longNorm = (lon + 180) / 360;
      let latNorm = (lat + 90) / 180;
      let lonCode = "", latCode = "";

      for (let i = 0; i < level; i++) {
        longNorm *= base;
        latNorm *= base;
        lonCode += nacChars[Math.floor(longNorm)];
        latCode += nacChars[Math.floor(latNorm)];
        longNorm -= Math.floor(longNorm);
        latNorm -= Math.floor(latNorm);
      }

      return lonCode + " " + latCode;
    }

    function showNAC(lat, lon) {
      const nac = encodeNAC(5, lon, lat);
      nacBox.innerHTML = `NAC: ${nac} | Lat/Lon: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      nacBox.dataset.clipboard = `${nac} (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
    }

    nacBox.onclick = () => {
      navigator.clipboard.writeText(nacBox.dataset.clipboard || '').then(() => {
        nacBox.innerHTML += '<span style="margin-left:8px;color:green;">✔ Copied!</span>';
        setTimeout(() => showNAC(map.getCenter().lat, map.getCenter().lng), 1000);
      });
    };

    map.on('mousemove', e => showNAC(e.latlng.lat, e.latlng.lng));

    function handleSearch() {
      const query = searchInput.value.trim().toUpperCase();
      if (!query) return;

      if (/^[0-9BCDFGHJKLMNPQRSTVWXZ\-]+ [0-9BCDFGHJKLMNPQRSTVWXZ\-]+$/.test(query)) {
        const [lonCodeRaw, latCodeRaw] = query.split(' ');
        const bounds = getBoundingBox(lonCodeRaw, latCodeRaw);
        if (boxLayer) map.removeLayer(boxLayer);
        if (marker) map.removeLayer(marker);
        boxLayer = L.rectangle(bounds, { color: 'red', weight: 2 }).addTo(map);
        map.fitBounds(bounds);
      } else if (/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(query)) {
        const [lat, lon] = query.split(',').map(parseFloat);
        showPointOrBox(lat, lon, 4);
      } else {
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json`)
          .then(res => res.json())
          .then(results => {
            if (results.length > 0) {
              const { lat, lon } = results[0];
              showPointOrBox(parseFloat(lat), parseFloat(lon), 4);
            } else {
              alert('Location not found');
            }
          });
      }
    }

    function showPointOrBox(lat, lon, level) {
      const nac = encodeNAC(level, lon, lat);
      if (marker) map.removeLayer(marker);
      if (boxLayer) map.removeLayer(boxLayer);

      if (level < 4) {
        const { resolution } = decodeNAC(nac);
        const sw = [lat - resolution * 90, lon - resolution * 180];
        const ne = [lat + resolution * 90, lon + resolution * 180];
        boxLayer = L.rectangle([sw, ne], { color: 'red', weight: 2 }).addTo(map);
        map.fitBounds([sw, ne]);
      } else {
        marker = L.marker([lat, lon]).addTo(map).bindPopup(`NAC: ${nac}`).openPopup();
        map.setView([lat, lon], 6);
      }
    }

    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        handleSearch();
      }
    });
  </script>
</body>
</html>
